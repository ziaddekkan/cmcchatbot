from tensorflow.keras.models import load_model
model = load_model('cmcbot.h5')
import numpy as np
import string
from nltk import WordNetLemmatizer
from nltk.tokenize import word_tokenize
import random
import json 
with open("fulldata.json","r",encoding="utf-8") as file :
    chat_data = json.load(file)
classes = ['alumni_success', 'program_comparison', 'admission_requirements', 'ai_definition', 'substance_abuse', 'immune_system', 'computerhod', 'nutrition_for_athletes', 'disease_prevention', 'cancer_support', 'campus_life', 'nutrition_advice', 'aging_health', 'gut_health', 'uniform', 'college intake', 'asthma prevention', 'sexual_health', 'mindfulness_meditation', 'nutrition_labels', 'self_care_tips', 'depression prevention', 'medication', 'organ_donation', 'fever prevention', 'elderly_care', 'mental_health', 'mental_health_support', 'diet_nutrition', 'faculty_expertise', 'random', 'dental_care', 'teen_nutrition', 'addiction_recovery', 'emergency', 'goodbye', 'fitness_motivation', 'digital_health', 'insurance', 'facilities', 'youth_health', 'infrastructure', 'bot_identity', 'mind_body_connection', 'hands_on_projects', 'pregnancy', 'greeting', 'scholarship', 'symptoms', 'vision_care', 'dental_health', 'fever symptoms', 'women_health', 'ithod', 'allergies', 'miscellaneous_questions', 'appointment', 'library', 'salutation', 'application_steps', 'extchod', 'international_students', 'floors', 'common cold prevention', 'insurance_claim', 'hours', 'vaccination', 'document', 'vacation', 'swear', 'menstrual_health', 'common cold symptoms', 'Asthma symptoms', 'sem', 'exercise_recommendation', 'chronic_conditions', 'weight_management', 'heart_health', 'certification_value', 'age', 'canteen', 'prerequisite_skills', 'core_curriculum', 'home_remedies', 'holistic_health', 'elderly_nutrition', 'nutrition_supplements', 'physical_therapy', 'exercise_injuries', 'further_learning', 'rehabilitation', 'cognitive_health', 'tech_requirements', 'Depression symptoms', 'name', 'menu', 'caregiving_tips', 'time_commitment', 'committee', 'placement', 'sleep_health', 'error_resolution', 'specialization_options', 'diabetes prevention', 'stress_management', 'creator', 'sleep_disorders', 'principal', 'hod', 'aging_gracefully', 'career_services', 'mindful_eating', 'caregiver_support', 'number', 'course', 'skin_care', 'lifestyle_changes', 'child_nutrition', 'ragging', 'event', 'nutrition_myths', 'travel_health', 'child_health', 'financial_support', 'Diabetes symptoms', 'reproductive_health', 'exercise', 'task', 'syllabus', 'first_aid', 'Consultation', 'sports']
lemmatizer = WordNetLemmatizer()
unique_tokens = ['idiot', 'heyy', 'health', 'faculty', 'miss', 'scan', 'control', 'deal', 'question', 'breathing', 'leave', 'visit', 'univrsity', 'helpful', 'parent', 'natural', 'you', 'understand', 'contraception', 'fuck', 'ideal', 'eat', 'allotment', 'cya', 'while', 'vaccine', 'appetite', 'breath', 'medicine', 'remedy', 'quality', 'per', 'sex', 'sun', 'lifelong', 'eater', 'subject', 'off', 'motivate', 'unwell', 'help', 'official', 'sustainable', 'cpr', 'prevent', 'coursework', 'pm', 'friendly', 'well', 'sweat', 'info', 'atmosphere', "'", 'athlete', 'strength', 'working', 'conduct', 'consultation', 'index', 'weakness', 'look', 'cancer', 'case', 'hopeless', 'someone', 'come', 'telephone', 'junior', 'concern', 'supplement', 'youth', 'app', 'infrastructure', 'attend', 'cramp', 'specification', 'dehydration', 'teenage', 'track', 'balanced', 'constitute', 'feel', 'gain', 'symptom', 'benefit', 'asthma', 'factor', 'training', 'permit', 'idea', 'differ', 'often', 'point', 'cold', 'prerequisite', 'acne', 'destination', 'dietary', 'brief', 'work', 'cut', 'investment', 'company', 'learn', 'bye', 'boost', 'component', 'result', 'document', 'timing', 'behavior', 'any', 'far', 'method', 'student', 'inaccurate', 'drink', 'must', 'value', 'good', 'comparison', 'advice', 'post', 'availability', 'degree', 'screening', 'become', 'we', 'necessity', 'eye', 'status', 'sign', 'alumnus', 'comparative', 'cost', 'woman', 'brain', 'world', 'shut', 'human', 'lose', 'go', 'effect', 'brace', 'class', 'after', 'apnea', 'answer', 'bring', 'branch', 'agility', 'bmi', 'live', 'should', 'saturday', 'tooth', 'name', 'term', 'workout', 'jet', 'care', 'stundent', 'simple', 'response', 'where', 'committee', 'prior', 'alternative', 'average', 'completion', 'expertise', 'when', 'wearer', 'mark', 'technology', 'recipe', 'therapist', 'culture', 'there', 'whom', 'competitor', 'edge', 'child', 'abroad', 'legal', 'ongoing', 'u', 'death', 'home', 'schedule', 'life', 'ragging', 'civil', 'awareness', 'communication', 'base', 'fourth', 'pick', 'find', 'exactly', 'doctor', 'suffer', 'allergy', 'mindfulness', 'finish', 'teach', 'graduate', 'regular', 'online', 'obesity', 'sport', 'wear', 'virtual', 'dental', 'congestion', 'sleep', 'advancement', 'preparatory', 'allocation', 'stroke', 'encourage', 'pressure', 'criterion', 'these', 'preparation', 'your', 'vaccinate', 'nutrition', 'resident', 'impact', 'not', 'one', 'laptop', 'fertility', 'use', 'buy', 'see', 'teacher', 'self', 'blurry', 'workplace', 'kind', 'new', 'runny', 'academic', 'it', 'demand', 'healthy', 'deliver', 'fucker', 'operation', 'program', 'recovery', 'second', 'dementia', 'advanced', 'medication', 'certification', 'physical', 'standing', 's', 'burn', 'timetable', 'enrollment', 'choose', 'unrelated', 'inquiry', 'infertility', 'headache', 'workshop', 'misinterpret', 'insomnia', 'that', 'dumb', 'activity', 'benchmark', 'ya', 'an', 'realistic', 'compare', 'mean', 'expect', 'insurance', 'foundational', 'interpret', 'need', 'prenatal', 'muscle', 'fatigue', 'funding', 'disorder', 'subsequent', 'cognitive', 'package', 'time', 'practice', 'dentist', 'focus', 'nose', 'management', 'many', 'irrelevant', 'appointment', 'right', 'emphasis', 'admit', 'allergen', 'specialization', 'stupid', 'image', 'thank', '/', 'cause', 'relief', 'gtg', 'fund', 'credibility', 'obligatory', 'therapy', 'k', 'center', 'list', 'slight', 'infectious', 'feature', "'s", 'stand', 'enough', 'adult', 'here', 'interest', 'weekly', 'definition', 'whatsup', 'this', 'versus', 'incorrect', 'hotline', 'have', 'opportunity', 'native', 'max', 'free', 'meal', 'anyone', 'age', 'chronic', 'canteen', 'job', 'concentration', 'digestive', 'recruitment', 'contact', 'capability', 'curriculum', 'nice', 'goal', 'design', 'irritability', 'prep', 'eating', 'low', 'daily', 'listen', 'holiday', 'handle', 'mask', 'distinguish', 'building', 'minimum', 'can', 'before', 'continued', 'matter', 'weight', 'option', 'admision', 'menu', 'core', 'practical', 'myth', 'prebiotic', 'and', 'unhelpful', 'placement', 'meditation', 'hydration', 'mechanical', 'stay', 'about', 'surgery', 'being', 'identity', 'principal', 'injury', 'issue', 'financial', 'frequent', 'antiragge', 'gluten', 'number', 'requirement', 'school', 'information', 'admission', 'separate', 'beginner', 'cover', 'education', 'be', 'general', 'joint', 'organ', 'urination', 'development', 'ailment', 'incident', 'debunk', 'call', 'in', 'step', 'counseling', 'pre', 'necessary', 'certify', 'memory', 'background', 'strategy', 'statistic', 'up', 'mass', 'herbal', 'graduation', 'emotional', 'application', 'meaning', 'policy', 'treat', 'embrace', 'make', 'cycle', 'precaution', 'shiver', 'loss', 'uni', 'ambulance', 'toothpaste', 'implant', 'positive', 'addiction', 'explanation', 'increase', 'relevant', 'mental', 'eligibility', 'flexibility', 'recover', 'thirst', 'cafetaria', 'mindful', 'irregularity', 'portfolio', 'uniform', 'lense', 'dosage', 'assistance', 'gut', 'game', 'main', 'tightness', 'long', 'else', 'offer', 'process', 'professional', 'panic', 'breast', 'importance', 'study', 'donor', 'simply', 'whatv', 'lunch', 'hour', 'entry', 'readiness', 'overcome', 'technique', 'thinking', 'specific', 'mineral', 'food', 'pain', 'fever', 'computer', 'emergency', 'require', 'difficulty', 'intelligence', 'outlook', 'superior', 'substance', 'at', 'path', 'scholarship', 'mild', 'describe', 'please', 'accredit', 'postmenopausal', 'stuffy', 'mandatory', 'chemotherapy', 'vitamin', 'market', 'advantage', 'parenting', 'chat', 'by', 'from', 'non', 'habit', 'decline', 'who', 'credential', 'skin', 'effective', 'diy', 'will', 'credible', 'cardio', 'birth', 'instruction', 'chest', 'lecturer', 'maintain', 'interaction', 'choice', 'exam', 'depression', 'support', 'next', 'vacation', 'campus', 'suggestion', 'holistic', 'chemical', 'committe', 'service', 'week', 'fundamental', 'plan', 'coding', 'kid', 'unique', 'know', 'legitimate', 'organise', 'the', 'anxious', 'improvement', 'challenge', 'rag', 'love', 'future', 'prevention', 'thing', 'ache', 'exist', 'machine', 'out', 'wrong', 'hunger', 'description', 'tip', 'vibe', 'diabete', 'reduction', 'immune', 'okie', 'wellness', 'project', 'implementation', 'facility', 'hardware', 'misconception', 'attack', 'how', 'take', 'asshole', 'aspect', 'software', 'explain', 'accreditation', 'mind', 'donation', 'why', 'educator', 'illness', 'want', 'recognition', 'instructor', 'read', 'year', 'specialty', 'chill', 'intake', 'would', 'shortness', 'date', 'college', 'body', 'device', 'menstrual', 'community', 'creator', 'yourself', 'acceptance', 'generally', 'payment', 'later', 'environment', 'assistive', 'office', 'glass', 'truth', 'each', 'travel', 'course', 'labor', 'aid', 'fall', 'teen', 'respite', 'professor', 'outcome', 'or', 'event', 'apart', 'hi', 'dresscode', 'label', 'dress', 'ok', 'joy', 'tell', 'sore', 'specialize', 'lifestyle', 'do', 'senior', 'useful', 'common', 'testing', 'skill', 'compulsory', 'level', 'exercise', 'reproductive', 'hunting', 'syllabus', 'computing', 'avoid', 'flu', 'change', 'seat', 'procedure', 'vision', 'some', 'role', 'sensitivity', 'plateau', 'getting', 'gracefully', 'of', 'detail', 'learning', 'engineering', 'foreign', 'introduce', 'minor', 'arthritis', 'face', 'transplant', 'mechanism', 'guidance', 'problem', 'treatment', 'fullness', 'fact', 'relate', 'technical', 'delivery', 'ingredient', 'apply', 'phase', 'what', 'start', 'knowledge', 'bot', 'childhood', 'a', 'something', 'spread', 'basic', 'okay', 'industry', 'sexual', 'tall', 'hello', 'condition', 'abuse', 'first', 'during', 'research', 'keep', 'old', 'essential', 'variety', 'blood', 'tea', 'caregiver', 'automobile', 'provide', 'urgent', 'workload', 'function', 'throat', 'yoga', 'cue', 'lecture', 'side', 'employment', 'wearable', 'connection', 'recognize', 'follow', 'if', 'goodbye', 'define', 'strengthen', 'against', 'protection', 'third', 'grade', 'talk', 'group', 'extc', 'irregular', 'respect', 'create', 'switch', 'pregnancy', 'set', 'overseas', 'guy', 'hell', 'introduction', '12', 'diet', 'elderly', 'medical', 'lag', 'book', 'than', 'bitch', 'claim', 'immunization', 'heart', 'resource', 'bedtime', 'anxiety', 'ttyl', 'code', 'library', 'disease', 'hold', 'adolescent', 'direction', 'patient', 'oral', 'probiotic', 'ai', 'planning', 'strain', 'sneeze', 'artificial', 'another', 'vaccination', 'calorie', 'educational', 'developer', 'actual', 'picky', 'competitive', 'std', 'available', 'active', 'experience', 'address', 'sem', 'improve', 'build', 'misunderstood', 'floor', 'commitment', 'worth', 'with', 'safe', 'm', 'my', 'immunity', 'size', 'safety', 'history', 'casual', 'topic', 'diabetes', 'file', 'other', 'day', 'relaxation', 'central', 'pay', 'I', 'continue', 'purpose', 'join', 'hygiene', 'enroll', 'phone', 'end', 'timeline', 'sti', 'cope', 'relapse', 'for', 'rehabilitation', 'preliminary', 'hand', 'no', 'extreme', 'visa', 'meeting', 'citizen', 'duration', 'manage', 'present', 'area', 'stress', 'malaise', 'get', 'as', 'marry', 'ml', 'hod', 'supportive', 'expectation', 'okk', 'real', 'success', 'tuition', 'which', 'achievement', 'search', 'routine', 'semester', 'comp', 'give', 'publication', 'check', 'cough', 'different', 'qualification', 'international', 'snack', 'applicant', 'system', 'ask', 'open', 'prepare', 'spec', 'maximum', 'career', 'fitness', 'validation', 'reputation', 'more', 'vegan', 'special', 'to'] 
word_to_index = {word: i for i, word in enumerate(unique_tokens)}
def predict_response(sentence):
    # Prétraitement : Tokenisation et lemmatisation
    tokens = word_tokenize(sentence.lower())
    tokens = [lemmatizer.lemmatize(token) for token in tokens if token not in string.punctuation]

    # Transformer la phrase en One-Hot Encoding
    vector = [0] * len(unique_tokens)
    for token in tokens:
        if token in word_to_index:
            vector[word_to_index[token]] = 1  # Activer l'index correspondant

    # Convertir en format compatible avec TensorFlow
    input_data = np.array([vector])

    # Prédiction du modèle
    prediction = model.predict(input_data)
    intent_index = np.argmax(prediction)  # Trouver l'index avec la plus grande probabilité
    predicted_intent = classes[intent_index]  # Récupérer l'intention correspondante

    for intent_data in chat_data:
        if intent_data["tag"] == predicted_intent:
            response = random.choice(intent_data["responses"])  # Choisir une réponse aléatoire
            return response
        
from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse
from fastapi.templating import Jinja2Templates
from fastapi.staticfiles import StaticFiles
from pydantic import BaseModel

app = FastAPI()

templates = Jinja2Templates(directory="templates")

class UserInput(BaseModel):
    message: str

# Route pour servir la page HTML
@app.get("/", response_class=HTMLResponse)
async def index(request: Request):
    return templates.TemplateResponse("index.html", {"request": request})

# Endpoint d'API
@app.post("/chat")
async def chat(text: UserInput):
    response = predict_response(text.message)
    return {"cmcbot": response}